<!DOCTYPE html><html lang="en"><head><title>core/remote_store</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="core/remote_store"><meta name="groc-project-path" content="src/core/remote_store.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/core/remote_store.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="remotestore">RemoteStore</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add / find / update / remove objects in a Couch Database</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="api">API</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>find(type, id)</li>
<li>findAll(type )</li>
<li>add(type, object)</li>
<li>save(type, id, object)</li>
<li>update(new_properties )</li>
<li>updateAll( type, new_properties)</li>
<li>remove(type, id)</li>
<li>removeAll(type)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="event-binding">Event binding</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>on(event, callback)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">RemoteStore</span> <span class="k">extends</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Store</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="constructor-">Constructor </h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sets name (think: namespace) and some other options</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor : </span><span class="nf">(@hoodie, @remote) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="find">find</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>find one object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">find : </span><span class="nf">(type, id) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">path = </span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@remote</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@parseFromRemote</span><span class="p">)</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="findall">findAll</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>find all objects, can be filetered by a type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">findAll : </span><span class="nf">(type) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">path = </span><span class="s">&quot;/_all_docs?include_docs=true&quot;</span>
    <span class="k">switch</span> <span class="kc">true</span>
      <span class="k">when</span> <span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">isnt</span> <span class="s">&#39;&#39;</span>
        <span class="nv">keyPrefix = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">when</span> <span class="nx">type</span><span class="o">?</span>
        <span class="nv">keyPrefix = </span><span class="nx">type</span>
      <span class="k">when</span> <span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">isnt</span> <span class="s">&#39;&#39;</span>
        <span class="nv">keyPrefix = </span><span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span>
      <span class="k">else</span>
        <span class="nv">keyPrefix = </span><span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="nx">keyPrefix</span>
      <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&amp;startkey=\&quot;</span><span class="si">#{</span><span class="nx">keyPrefix</span><span class="si">}</span><span class="s">\/\&quot;&amp;endkey=\&quot;</span><span class="si">#{</span><span class="nx">keyPrefix</span><span class="si">}</span><span class="s">0\&quot;&quot;</span>

    <span class="nv">promise = </span><span class="nx">@remote</span><span class="p">.</span><span class="nx">request</span> <span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">path</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">fail</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_mapDocsFromFindAll</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@parseAllFromRemote</span><span class="p">).</span><span class="nx">done</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="save">save</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save a new object. If it existed before, all properties
will be overwritten </p></div></div><div class="code"><div class="wrapper">  <span class="nv">save : </span><span class="nf">(type, id, object) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">id = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">uuid</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">id</span> 
    <span class="nv">object = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span>
      <span class="nv">type : </span><span class="nx">type</span>
      <span class="nv">id    : </span><span class="nx">id</span>
    <span class="p">},</span> <span class="nx">object</span>

    <span class="nv">doc   = </span><span class="nx">@parseForRemote</span> <span class="nx">object</span>
    <span class="nv">path  = </span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span>

    <span class="nx">@remote</span><span class="p">.</span><span class="nx">request</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nv">data: </span><span class="nx">doc</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="remove">remove</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove one object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">remove : </span><span class="nf">(type, id) -&gt;</span>
    <span class="nx">@update</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nv">_deleted: </span><span class="kc">true</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="removeall">removeAll</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove all objects, can be filtered by type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">removeAll : </span><span class="nf">(type) -&gt;</span>
    <span class="nx">@updateAll</span> <span class="nx">type</span><span class="p">,</span> <span class="nv">_deleted: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="parse-for-remote">Parse for remote</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>parse object for remote storage. All attributes starting with an 
<code>underscore</code> do not get synchronized despite the special attributes
<code>_id</code>, <code>_rev</code> and <code>_deleted</code> (see above)</p>

<p>Also <code>id</code> gets replaced with <code>_id</code> which consists of type &amp; id</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">parseForRemote : </span><span class="nf">(obj) -&gt;</span>
    <span class="nv">attributes = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">obj</span>
  
    <span class="k">for</span> <span class="nx">attr</span> <span class="k">of</span> <span class="nx">attributes</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="o">~</span><span class="nx">@_validSpecialAttributes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
      <span class="k">continue</span> <span class="k">unless</span> <span class="sr">/^_/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">attr</span>
      <span class="k">delete</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
   </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prepare CouchDB id</p></div></div><div class="code"><div class="wrapper">    <span class="nv">attributes._id = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span>
      <span class="nv">attributes._id = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">_id</span><span class="si">}</span><span class="s">&quot;</span>
    
    <span class="k">delete</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span>

    <span class="k">return</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="parsefromremote">parseFromRemote</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>normalize objects coming from remote</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>renames <code>_id</code> attribute to <code>id</code> and removes the type from the id,
e.g. <code>document/123</code> -> <code>123</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseFromRemote : </span><span class="nf">(obj) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle id and type</p></div></div><div class="code"><div class="wrapper">    <span class="nv">id = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span>
    <span class="nv">id = </span><span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="o">+</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@remote</span><span class="p">.</span><span class="nx">prefix</span>
    <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\//</span><span class="p">)</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle timestameps</p></div></div><div class="code"><div class="wrapper">    <span class="nv">obj.createdAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">createdAt</span>
    <span class="nv">obj.updatedAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">updatedAt</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle rev</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">rev</span>
      <span class="nv">obj._rev = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">rev</span>
      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">rev</span>
    
    <span class="k">return</span> <span class="nx">obj</span>
  
  <span class="nv">parseAllFromRemote : </span><span class="nf">(objects) =&gt;</span>
    <span class="nx">@parseFromRemote</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="k">for</span> <span class="nx">object</span> <span class="k">in</span> <span class="nx">objects</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="addrevisionto">addRevisionTo</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extends passed object with a _rev property</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">addRevisionTo : </span><span class="nf">(attributes) -&gt;</span>

    <span class="k">try</span> <span class="p">[</span><span class="nx">currentRevNr</span><span class="p">,</span> <span class="nx">currentRevId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">_rev</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/-/</span>
    <span class="nv">currentRevNr = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">currentRevNr</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>

    <span class="nv">newRevisionId         = </span><span class="nx">@_generateNewRevisionId</span><span class="p">()</span>
    <span class="nv">attributes._rev       = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">currentRevNr</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">-</span><span class="si">#{</span><span class="nx">newRevisionId</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">attributes._revisions = </span>
      <span class="nv">start : </span><span class="mi">1</span>
      <span class="nv">ids   : </span><span class="p">[</span><span class="nx">newRevisionId</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">currentRevId</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_revisions</span><span class="p">.</span><span class="nx">start</span> <span class="o">+=</span> <span class="nx">currentRevNr</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_revisions</span><span class="p">.</span><span class="nx">ids</span><span class="p">.</span><span class="nx">push</span> <span class="nx">currentRevId</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="events">Events</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.on</code></p></div></div><div class="code"><div class="wrapper">  <span class="kc">on</span>  <span class="o">:</span> <span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">:store:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">on</span>  <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="nv">one : </span><span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">:store:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">one</span>  <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.trigger</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">trigger : </span><span class="nf">(event, parameters...) -&gt;</span> 
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@remote</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">:store:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>valid CouchDB doc attributes starting with an underscore</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_validSpecialAttributes : </span><span class="p">[</span>
    <span class="s">&#39;_id&#39;</span><span class="p">,</span> <span class="s">&#39;_rev&#39;</span><span class="p">,</span> <span class="s">&#39;_deleted&#39;</span><span class="p">,</span> <span class="s">&#39;_revisions&#39;</span><span class="p">,</span> <span class="s">&#39;_attachments&#39;</span>
  <span class="p">]</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="generate-new-revision-id">generate new revision id</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">_generateNewRevisionId: </span> <span class="nf">-&gt;</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">uuid</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="map-docs-from-findall">map docs from findAll</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_mapDocsFromFindAll: </span><span class="nf">(response) =&gt;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">doc</span></div></div></div></div></body></html>