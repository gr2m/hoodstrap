<!DOCTYPE html><html lang="en"><head><title>core/remote</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="core/remote"><meta name="groc-project-path" content="src/core/remote.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/core/remote.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="remotestore">RemoteStore</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Connection to a remote Couch Database.</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="thisstore-api">this.store API</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>object loading / updating / deleting</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>store.find(type, id)</li>
<li>store.findAll(type )</li>
<li>store.add(type, object)</li>
<li>store.save(type, id, object)</li>
<li>store.update(new_properties )</li>
<li>store.updateAll( type, new_properties)</li>
<li>store.remove(type, id)</li>
<li>store.removeAll(type)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>custom requests</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>request(view, params)</li>
<li>get(view, params)</li>
<li>post(view, params)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>synchronization</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>connect()</li>
<li>disconnect()</li>
<li>pull()</li>
<li>push()</li>
<li>sync()</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>event binding</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>on(event, callback)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Remote</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="properties">properties</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store  </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store class that the remote will use to connect to.
We make it a property so that classes can easily inherit
from Hoodie.Remote and overWrite its Store</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Store : </span><span class="nx">Hoodie</span><span class="p">.</span><span class="nx">RemoteStore</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>name  </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the name of the RemoteStore is the name of the
CouchDB database and is also used to prefix 
triggered events</p></div></div><div class="code"><div class="wrapper">  <span class="nv">name : </span><span class="kc">undefined</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sync  </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if set to true, updates will be continuously pulled
and pushed. Alternatively, <code>sync</code> can be set to
<code>pull: true</code> or <code>push: true</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_sync : </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>docPrefix</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prefix of docs in CouchDB Database, e.g. all docs
in public user stores are prefixed by '$public'</p></div></div><div class="code"><div class="wrapper">  <span class="nv">prefix : </span><span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="constructor-">Constructor </h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sets name (think: namespace) and some other options</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor : </span><span class="nf">(@hoodie, options = {}) -&gt;</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span>
      <span class="vi">@name = </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span>     
      <span class="vi">@prefix = </span><span class="nx">@name</span>
      
    <span class="vi">@prefix = </span><span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span><span class="o">?</span>

    <span class="vi">@_sync   = </span><span class="nx">options</span><span class="p">.</span><span class="nx">sync</span>   <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sync</span>
    <span class="vi">@store   = </span><span class="k">new</span> <span class="nx">@Store</span> <span class="nx">@hoodie</span><span class="p">,</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>NOTE: 
Due to a bug in Chrome (I guess), the loader won't disappear
when the page is loaded, when we start a long poll request
before the page loaded.
On the other side, we do not want to wait for to the page
and all its assets to be loaded before we start loading
our data. 
A good way to fix it would be a special <code>bootstrap</code> method,
that would all docs with a normal GET /<em>all</em>docs request,
after that it would start with the GET /_changes requests,
starting with the current seq number of the database.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@startSyncing</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@isContinuouslySyncing</span><span class="p">()</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="request">request</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>wrapper for hoodie.request, with some store specific defaults
and a prefixed path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">request : </span><span class="nf">(type, path, options = {}) -&gt;</span>
    <span class="nv">path = </span><span class="s">&quot;/</span><span class="si">#{</span><span class="nb">encodeURIComponent</span> <span class="nx">@name</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">@name</span>

    <span class="nx">options</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">or=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;POST&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;PUT&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">dataType</span>    <span class="o">or=</span> <span class="s">&#39;json&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">processData</span> <span class="o">or=</span> <span class="kc">false</span>
      <span class="nv">options.data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="get">get</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>send a GET request to the named view</p></div></div><div class="code"><div class="wrapper">  <span class="nv">get : </span><span class="nf">(view_name, params) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;.get() not yet implemented&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="post">post</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sends a POST request to the specified updated_function</p></div></div><div class="code"><div class="wrapper">  <span class="nv">post : </span><span class="nf">(update_function_name, params) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;.post() not yet implemented&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="synchronization">synchronization</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="connect">Connect</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start syncing</p></div></div><div class="code"><div class="wrapper">  <span class="nv">connect : </span><span class="nf">(options) =&gt;</span>
    <span class="vi">@connected = </span><span class="kc">true</span>
    <span class="nx">@sync</span><span class="p">()</span>
  
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="disconnect">Disconnect</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stop syncing changes from the userDB</p></div></div><div class="code"><div class="wrapper">  <span class="nv">disconnect : </span><span class="o">=&gt;</span>
    <span class="vi">@connected = </span><span class="kc">false</span>
    
    <span class="nx">@_pullRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
    <span class="nx">@_pushRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="startsyncing">startSyncing</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start continuous syncing with current users store</p></div></div><div class="code"><div class="wrapper">  <span class="nv">startSyncing : </span><span class="o">=&gt;</span>
    <span class="vi">@_sync = </span><span class="kc">true</span>
    <span class="nx">@connect</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="stopsyncing">stopSyncing</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stop continuous syncing with current users store</p></div></div><div class="code"><div class="wrapper">  <span class="nv">stopSyncing : </span><span class="o">=&gt;</span>
    <span class="vi">@_sync = </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="iscontinuouslypulling">isContinuouslyPulling</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns true if pulling is set to be continous</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isContinuouslyPulling : </span><span class="nf">-&gt;</span>
    <span class="nx">@_sync</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">@_sync</span><span class="o">?</span><span class="p">.</span><span class="nx">pull</span> <span class="o">is</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="iscontinuouslypushing">isContinuouslyPushing</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns true if pulling is set to be continous</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isContinuouslyPushing : </span><span class="nf">-&gt;</span>
    <span class="nx">@_sync</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">@_sync</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="o">is</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="iscontinuouslysyncing">isContinuouslySyncing</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns true if pulling is set to be continous</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isContinuouslySyncing : </span><span class="nf">-&gt;</span>
    <span class="nx">@_sync</span> <span class="o">is</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getsincenr">getSinceNr</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns the sequence number from wich to start to find changes in pull</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">getSinceNr : </span><span class="nf">-&gt;</span>
    <span class="nx">@_since</span> <span class="o">or</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="setsincenr">setSinceNr</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sets the sequence number from wich to start to find changes in pull</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">setSinceNr : </span><span class="nf">(seq) -&gt;</span>
    <span class="vi">@_since = </span><span class="nx">seq</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="pull-changes">pull changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a.k.a. make a GET request to CouchDB's <code>_changes</code> feed.</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">pull : </span><span class="o">=&gt;</span>
    <span class="vi">@_pullRequest = </span><span class="nx">@request</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">@_pullUrl</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@connected</span> <span class="o">and</span> <span class="nx">@isContinuouslyPulling</span><span class="p">()</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span> <span class="nx">@_pullRequestTimeout</span>
      <span class="vi">@_pullRequestTimeout = </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@_restartPullRequest</span><span class="p">,</span> <span class="mi">25000</span> <span class="c1"># 25 sec</span>
    
    <span class="nx">@_pullRequest</span><span class="p">.</span><span class="nx">then</span> <span class="nx">@_handlePullSuccess</span><span class="p">,</span> <span class="nx">@_handlePullError</span>
    
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="push-changes">push changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push objects to userDB using the <code>_bulk_docs</code> API.
If no objects passed, push all changed documents</p></div></div><div class="code"><div class="wrapper">  <span class="nv">push : </span><span class="nf">(docs) =&gt;</span>
    
    <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">resolve</span><span class="p">([]).</span><span class="nx">promise</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">docs</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
      
    <span class="nv">docsForRemote = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">doc</span> <span class="k">in</span> <span class="nx">docs</span>
      <span class="nv">doc = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">parseForRemote</span> <span class="nx">doc</span> 
      <span class="nx">@store</span><span class="p">.</span><span class="nx">addRevisionTo</span> <span class="nx">doc</span>
      <span class="nx">docsForRemote</span><span class="p">.</span><span class="nx">push</span> <span class="nx">doc</span>
    
    <span class="vi">@_pushRequest = </span><span class="nx">@request</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&quot;/_bulk_docs&quot;</span>
      <span class="nv">data :</span>
        <span class="nv">docs      : </span><span class="nx">docsForRemote</span>
        <span class="nv">new_edits : </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when push is successful, update the local store with the generated _rev numbers</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@_pushRequest</span><span class="p">.</span><span class="nx">done</span> <span class="nx">@_handlePushSuccess</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">docsForRemote</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="sync-changes">sync changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pull ... and push ;-)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">sync : </span><span class="nf">(docs) =&gt;</span>
    <span class="nx">@push</span><span class="p">(</span><span class="nx">docs</span><span class="p">).</span><span class="nx">pipe</span> <span class="nx">@pull</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="events">Events</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.on</code></p></div></div><div class="code"><div class="wrapper">  <span class="kc">on</span>  <span class="o">:</span> <span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">on</span>  <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="nv">one : </span><span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">one</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.trigger</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">trigger : </span><span class="nf">(event, parameters...) -&gt;</span> 
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">...</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-url">pull url</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Depending on whether isContinuouslyPulling() is true, return a longpoll URL or not</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_pullUrl : </span><span class="nf">-&gt;</span>
    <span class="nv">since = </span><span class="nx">@getSinceNr</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@isContinuouslyPulling</span><span class="p">()</span> <span class="c1"># make a long poll request</span>
      <span class="s">&quot;/_changes?include_docs=true&amp;since=</span><span class="si">#{</span><span class="nx">since</span><span class="si">}</span><span class="s">&amp;heartbeat=10000&amp;feed=longpoll&quot;</span>
    <span class="k">else</span>
      <span class="s">&quot;/_changes?include_docs=true&amp;since=</span><span class="si">#{</span><span class="nx">since</span><span class="si">}</span><span class="s">&quot;</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>request gets restarted automaticcally 
when aborted (see @_handlePullError)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_restartPullRequest : </span><span class="o">=&gt;</span> <span class="nx">@_pullRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-success-handler">pull success handler</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle the incoming changes, then send the next request</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_handlePullSuccess : </span><span class="nf">(response) =&gt;</span>
    <span class="nx">@setSinceNr</span> <span class="nx">response</span><span class="p">.</span><span class="nx">last_seq</span>
    <span class="nx">@_handlePullResults</span> <span class="nx">response</span><span class="p">.</span><span class="nx">results</span>
    
    <span class="nx">@pull</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@connected</span> <span class="o">and</span> <span class="nx">@isContinuouslyPulling</span><span class="p">()</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-error-handler">pull error handler</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when there is a change, trigger event, 
then check for another change</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_handlePullError : </span><span class="nf">(xhr, error, resp) =&gt;</span>
    
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@connected</span>

    <span class="k">switch</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Session is invalid. User is still login, but needs to reauthenticate
before sync can be continued</p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">401</span>
        <span class="nx">@trigger</span> <span class="s">&#39;error:unauthenticated&#39;</span><span class="p">,</span> <span class="nx">error</span>
        <span class="nx">@disconnect</span><span class="p">()</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the 404 comes, when the requested DB has been removed
or does not exist yet.</p>

<p>BUT: it might also happen that the background workers did
     not create a pending database yet. Therefore,
     we try it again in 3 seconds</p></div></div><div class="code"><div class="wrapper">      <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: review / rethink that.</p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">404</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Please server, don't give us these. At least not persistently </p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">500</span>
        <span class="nx">@trigger</span> <span class="s">&#39;error:server&#39;</span><span class="p">,</span> <span class="nx">error</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>usually a 0, which stands for timeout or server not reachable.</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nx">@isContinuouslyPulling</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">is</span> <span class="s">&#39;abort&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>manual abort after 25sec. restart pulling changes directly when isContinuouslyPulling() is true</p></div></div><div class="code"><div class="wrapper">          <span class="nx">@pull</span><span class="p">()</span>
        <span class="k">else</span>    
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>oops. This might be caused by an unreachable server.
Or the server canceled it for what ever reason, e.g.
heroku kills the request after ~30s.
we'll try again after a 3s timeout</p></div></div><div class="code"><div class="wrapper">          <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="handle-changes-from-remote">handle changes from remote</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>in order to differentiate whether an object from remote should trigger a 'new'
or an 'update' event, we store a hash of known objects</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_knownObjects : </span><span class="p">{}</span>
  <span class="nv">_handlePullResults : </span><span class="nf">(changes) =&gt;</span>
    <span class="k">for</span> <span class="p">{</span><span class="nx">doc</span><span class="p">}</span> <span class="k">in</span> <span class="nx">changes</span>
      <span class="nv">parsedDoc = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">parseFromRemote</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">_deleted</span>
        <span class="nv">event = </span><span class="s">&#39;remove&#39;</span>
        <span class="k">delete</span> <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span>
          <span class="nv">event = </span><span class="s">&#39;update&#39;</span>
        <span class="k">else</span>
          <span class="nv">event = </span><span class="s">&#39;add&#39;</span>
          <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

      <span class="nx">@trigger</span> <span class="s">&quot;store:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>                                    <span class="nx">parsedDoc</span>
      <span class="nx">@trigger</span> <span class="s">&quot;store:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>                 <span class="nx">parsedDoc</span>
      <span class="nx">@trigger</span> <span class="s">&quot;store:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">parsedDoc</span>      
      <span class="nx">@trigger</span> <span class="s">&quot;store:change&quot;</span><span class="p">,</span>                                      <span class="nx">event</span><span class="p">,</span> <span class="nx">parsedDoc</span>
      <span class="nx">@trigger</span> <span class="s">&quot;store:change:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>                   <span class="nx">event</span><span class="p">,</span> <span class="nx">parsedDoc</span>
      <span class="nx">@trigger</span> <span class="s">&quot;store:change:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">parsedDoc</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>   <span class="nx">event</span><span class="p">,</span> <span class="nx">parsedDoc</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="handle-push-success">handle push success</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do nothing by default</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_handlePushSuccess : </span><span class="nf">(docs, pushedDocs) =&gt;</span> </div></div></div></div></body></html>